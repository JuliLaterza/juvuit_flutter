rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuarios
    match /users/{userId} {
      allow read, create, update, delete: if request.auth != null;

      // Likes recibidos
      match /likesReceived/{likerId} {
        allow read, create, update, delete: if request.auth != null;
      }

      // ✅ Likes dados (nuevo)
      match /likesGiven/{likedId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      // ✅ Bloqueados (nuevo)
      match /blocked/{blockedId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ✅ Likes recibidos (colección principal)
    match /likes_received/{userId} {
      allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ✅ Likes enviados (colección principal)
    match /likes_sent/{likeId} {
      allow read, create, update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
    }

    // ✅ Matches (simplificado temporalmente para debug)
    match /matches/{matchId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // ✅ Reportes (nuevo)
    match /reports/{reportId} {
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.reporterUserId;
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.reporterUserId || 
         request.auth.uid == resource.data.reportedUserId);
      allow update, delete: if false; // Solo admins pueden modificar/eliminar
    }

    // Eventos
    match /events/{eventId} {
      allow read, update, delete: if request.auth != null;
    }

    // ✅ Mensajes y subcolección chats (corregido: verifica participación en match)
    match /messages/{matchId} {
      allow read, write, delete: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;

      match /chats/{chatId} {
        allow read, write, delete: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
      }
    }

    // Lectura general autenticada
    match /{document=**} {
      allow read: if request.auth != null;
    }
  }
}
